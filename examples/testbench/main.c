#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include "vm.h"

// Test vectors for the VM, generated by stepping the VM one group at a time,
// starting at address 0.
// Command in Tiff is "N make ../templates/testbench.c ../testbench/test.c".

// Test vectors are embedded in a function
// Register IDs: 0 to 5 = T, N, RP, SP, UP, PC

int errors = 0;
int TestID;

// C testbench:

uint32_t ChangeRegs[2][6];              // rows: old, new
int changed;                            // list of registers to check
int tests = 0;

static void RegChangeInit (void) {      // Initialize register changes
    for (int i=0; i<6; i++) {
        uint32_t x = vmRegRead(i);
        ChangeRegs[0][i] = x;
        ChangeRegs[1][i] = x;
    }
    ChangeRegs[1][5] -= 4;
    changed = 0;
}

static void RegChanges (void) {			// process registor changes
    memmove(ChangeRegs[1], ChangeRegs[0], 6*sizeof(uint32_t));
    for (int i=0; i<6; i++) {           // [1] = expected, [0] = actual
        ChangeRegs[0][i] = vmRegRead(i);
    }
    int changed = 0;
    for (int i=0; i<6; i++) {           // compare...
        uint32_t actual   = ChangeRegs[0][i];
        uint32_t expected = ChangeRegs[1][i];
        if (actual != expected) {
            changed |= (1<<i);          // tag the registers changed
        }
    }
}

static void newstep(uint32_t IR, int testID){
    if (changed) {
        printf("Unexpected changes detected in test %d: ", TestID);
        for (int i=0; i<6; i++) {
            if ((1<<i) & changed) {
                printf("%d ", i);
            }
        }
        printf("\n");
    }
    VMstep(IR, 0);
    RegChanges();
    TestID = testID;
    tests++;
};

static void changes(int Reg, uint32_t actual){
	static uint32_t previous = 0;
    if (actual != ChangeRegs[0][Reg]) {
        errors++;
        printf("[%d]: New R%d: expected 0x%08X, is 0x%08X, old was 0x%08X\n",
               TestID, Reg, actual, ChangeRegs[0][Reg], previous);
    }
    changed &= ~(1<<Reg);               // tag as checked
	previous = actual;
};

int main()
{
	VMpor();
	RegChangeInit();

//           INS_GROUP  Test#
    newstep(0x4C000172, 0);  // PC = 0000h
    changes(5, 0x000005C8);
    newstep(0x6C000120, 1);  // PC = 05C8h
    changes(2, 0x000080FC);
    changes(5, 0x00000480);
    newstep(0x09000000, 2);  // PC = 0480h
    changes(2, 0x00008100);
    changes(5, 0x000005CC);
    newstep(0x6C000121, 3);  // PC = 05CCh
    changes(2, 0x000080FC);
    changes(5, 0x00000484);
    newstep(0x01000000, 4);  // PC = 0484h
    newstep(0xE40004D2, 5);  // PC = 0488h
    changes(0, 0x000004D2);
    changes(3, 0x0000807C);
    newstep(0x05000000, 6);  // PC = 048Ch
    changes(1, 0x000004D2);
    changes(3, 0x00008078);
    newstep(0xAD000000, 7);  // PC = 0490h
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0x05000000, 8);  // PC = 0494h
    changes(1, 0x000004D2);
    changes(3, 0x00008078);
    newstep(0x85000000, 9);  // PC = 0498h
    changes(0, 0x000004D6);
    newstep(0x0D000000, 10);  // PC = 049Ch
    changes(0, 0x000009A8);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0x15000000, 11);  // PC = 04A0h
    changes(0, 0x00000000);
    newstep(0x45000000, 12);  // PC = 04A4h
    changes(0, 0x00000002);
    newstep(0xFD000000, 13);  // PC = 04A8h
    changes(0, 0xFFFFFFFD);
    newstep(0x05A40000, 14);  // PC = 04ACh
    changes(2, 0x000080F8);
    newstep(0x1D000000, 15);  // PC = 04B0h
    changes(0, 0xFFFFFFFE);
    newstep(0x25000000, 16);  // PC = 04B4h
    changes(0, 0xFFFFFFFF);
    newstep(0xF9000000, 17);  // PC = 04B8h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0xFC90D000, 18);  // PC = 04BCh
    changes(0, 0x00000002);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0x19000000, 19);  // PC = 04C0h
    changes(0, 0xFFFFFFFD);
    changes(1, 0x00000002);
    changes(2, 0x000080FC);
    changes(3, 0x00008078);
    newstep(0x7D000000, 20);  // PC = 04C4h
    changes(0, 0xFFFFFFFF);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0x75000000, 21);  // PC = 04C8h
    changes(0, 0x00000000);
    newstep(0x74540000, 22);  // PC = 04CCh
    changes(0, 0xFFFFFFFF);
    newstep(0xE4BC614E, 23);  // PC = 04D0h
    changes(0, 0x00BC614E);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0xE4008268, 24);  // PC = 04D4h
    changes(0, 0x00008268);
    changes(1, 0x00BC614E);
    changes(3, 0x00008074);
    newstep(0x05A40000, 25);  // PC = 04D8h
    changes(2, 0x000080F8);
    newstep(0x95000000, 26);  // PC = 04DCh
    changes(0, 0x0000826C);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0xAD000000, 27);  // PC = 04E0h
    changes(0, 0xFFFFFFFF);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0xF8E40000, 28);  // PC = 04E4h
    changes(0, 0x0000004E);
    changes(1, 0x00008269);
    changes(3, 0x00008074);
    newstep(0x29000000, 29);  // PC = 04E8h
    changes(0, 0x00008269);
    changes(1, 0x0000004E);
    newstep(0xD9000000, 30);  // PC = 04ECh
    changes(0, 0x00000061);
    newstep(0xAEB40000, 31);  // PC = 04F0h
    changes(0, 0xFFFFFFFF);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0xF9640000, 32);  // PC = 04F4h
    changes(0, 0x0000614E);
    changes(1, 0x0000826A);
    changes(3, 0x00008074);
    newstep(0x29000000, 33);  // PC = 04F8h
    changes(0, 0x0000826A);
    changes(1, 0x0000614E);
    newstep(0x79000000, 34);  // PC = 04FCh
    changes(0, 0x000000BC);
    newstep(0xAEB40000, 35);  // PC = 0500h
    changes(0, 0xFFFFFFFF);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0xFA640000, 36);  // PC = 0504h
    changes(0, 0x00BC614E);
    changes(1, 0x0000826C);
    changes(3, 0x00008074);
    newstep(0x29000000, 37);  // PC = 0508h
    changes(0, 0x0000826C);
    changes(1, 0x00BC614E);
    newstep(0xB9000000, 38);  // PC = 050Ch
    changes(0, 0x00000000);
    newstep(0x5D000000, 39);  // PC = 0510h
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0xE40003E8, 40);  // PC = 0514h
    changes(0, 0x000003E8);
    changes(1, 0x00000000);
    changes(3, 0x00008074);
    newstep(0xF95AD000, 41);  // PC = 0518h
    changes(0, 0x00000000);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0xF9E40000, 42);  // PC = 051Ch
    changes(0, 0x000003E8);
    changes(1, 0x00000000);
    changes(3, 0x00008074);
    newstep(0xAF900063, 43);  // PC = 0520h
    changes(0, 0x00000063);
    newstep(0xF8DAD000, 44);  // PC = 0524h
    changes(0, 0x00000000);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0x1B640000, 45);  // PC = 0528h
    changes(0, 0x00000063);
    changes(1, 0x00000000);
    changes(2, 0x000080FC);
    changes(3, 0x00008074);
    newstep(0x8D000000, 46);  // PC = 052Ch
    changes(0, 0x00000064);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0x89000000, 47);  // PC = 0530h
    changes(0, 0xFFFFFFFF);
    changes(1, 0x00000064);
    changes(3, 0x00008074);
    newstep(0x3D000000, 48);  // PC = 0534h
    changes(0, 0x7FFFFFFF);
    newstep(0x1D000000, 49);  // PC = 0538h
    changes(0, 0x3FFFFFFF);
    newstep(0x8D000000, 50);  // PC = 053Ch
    changes(0, 0x40000064);
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0x29000000, 51);  // PC = 0540h
    changes(0, 0xFFFFFFFF);
    changes(1, 0x40000064);
    newstep(0x1CF40000, 52);  // PC = 0544h
    changes(0, 0x7FFFFFFF);
    newstep(0xBD000000, 53);  // PC = 0548h
    changes(0, 0xFFFFFFFF);
    newstep(0x9D000000, 54);  // PC = 054Ch
    changes(0, 0xFFFFFFFE);
    newstep(0xFC340000, 55);  // PC = 0550h
    changes(0, 0x40000065);
    changes(1, 0x00000000);
    changes(3, 0x0000807C);
    newstep(0x64000055, 56);  // PC = 0554h
    changes(0, 0x65000055);
    newstep(0xAC240000, 57);  // PC = 0558h
    changes(0, 0x00000000);
    changes(2, 0x00008100);
    changes(3, 0x00008080);
    changes(5, 0x000005D0);
    newstep(0xE400005B, 58);  // PC = 05D0h
    changes(0, 0x0000005B);
    changes(3, 0x0000807C);
    newstep(0x6C000157, 59);  // PC = 05D4h
    changes(2, 0x000080FC);
    changes(5, 0x0000055C);
    newstep(0x10000002, 60);  // PC = 055Ch
    changes(0, 0x00000000);
    newstep(0xAC240000, 61);  // PC = 0560h
    changes(2, 0x00008100);
    changes(3, 0x00008080);
    changes(5, 0x000005D8);
    newstep(0x6C000159, 62);  // PC = 05D8h
    changes(2, 0x000080FC);
    changes(5, 0x00000564);
    newstep(0xE40082F5, 63);  // PC = 0564h
    changes(0, 0x000082F5);
    changes(3, 0x0000807C);
    newstep(0xB9000000, 64);  // PC = 0568h
    changes(0, 0x00000000);
    changes(2, 0x000080F8);
    changes(5, 0x00000008);
    newstep(0x4C00015D, 65);  // PC = 0008h
    changes(5, 0x00000574);
    newstep(0x09000000, 66);  // PC = 0574h
    changes(2, 0x000080FC);
    changes(5, 0x0000056C);
    newstep(0xAD000000, 67);  // PC = 056Ch
    changes(3, 0x00008080);
    newstep(0x09000000, 68);  // PC = 0570h
    changes(2, 0x00008100);
    changes(5, 0x000005DC);
    newstep(0xE400002D, 69);  // PC = 05DCh
    changes(0, 0x0000002D);
    changes(3, 0x0000807C);
    newstep(0x6C000157, 70);  // PC = 05E0h
    changes(2, 0x000080FC);
    changes(5, 0x0000055C);
    newstep(0x10000002, 71);  // PC = 055Ch
    changes(0, 0x00000000);
    newstep(0xAC240000, 72);  // PC = 0560h
    changes(2, 0x00008100);
    changes(3, 0x00008080);
    changes(5, 0x000005E4);
    newstep(0x6C00015E, 73);  // PC = 05E4h
    changes(2, 0x000080FC);
    changes(5, 0x00000578);
    newstep(0xE4000000, 74);  // PC = 0578h
    changes(3, 0x0000807C);
    newstep(0xE40082F4, 75);  // PC = 057Ch
    changes(0, 0x000082F4);
    changes(3, 0x00008078);
    newstep(0xE4000004, 76);  // PC = 0580h
    changes(0, 0x00000004);
    changes(1, 0x000082F4);
    changes(3, 0x00008074);
    newstep(0x6C000070, 77);  // PC = 0584h
    changes(2, 0x000080F8);
    changes(5, 0x000001C0);
    newstep(0xFC9FD000, 78);  // PC = 01C0h
    changes(0, 0x00000003);
    newstep(0xC1300075, 79);  // PC = 01C4h
    newstep(0xFC929A28, 80);  // PC = 01C8h
    changes(0, 0x00000000);
    changes(1, 0xFFFFFFFD);
    changes(2, 0x000080F4);
    changes(3, 0x00008078);
    newstep(0x98695AA0, 81);  // PC = 01CCh
    changes(0, 0x00000010);
    changes(1, 0x00000001);
    newstep(0x1ABAEB08, 82);  // PC = 01D0h
    changes(0, 0x00000000);
    changes(1, 0x00000000);
    changes(2, 0x000080FC);
    changes(3, 0x00008080);
    changes(5, 0x00000588);
    newstep(0xE4008304, 83);  // PC = 0588h
    changes(0, 0x00008304);
    changes(3, 0x0000807C);
    newstep(0x07900010, 84);  // PC = 058Ch
    changes(0, 0x00000010);
    changes(1, 0x00008304);
    changes(3, 0x00008074);
    newstep(0x0F900010, 85);  // PC = 0590h
    changes(1, 0x00008314);
    newstep(0x6C000076, 86);  // PC = 0594h
    changes(2, 0x000080F8);
    changes(5, 0x000001D8);
    newstep(0xFC9FD000, 87);  // PC = 01D8h
    changes(0, 0x0000000F);
    newstep(0xC130007B, 88);  // PC = 01DCh
    newstep(0xFC929A28, 89);  // PC = 01E0h
    changes(0, 0x00008304);
    changes(1, 0xFFFFFFF1);
    changes(2, 0x000080F4);
    changes(3, 0x00008078);
    newstep(0x38635AA0, 90);  // PC = 01E4h
    changes(0, 0x00008314);
    changes(1, 0x00000001);
    newstep(0x1ABAEB08, 91);  // PC = 01E8h
    changes(0, 0x00000000);
    changes(1, 0x00000000);
    changes(2, 0x000080FC);
    changes(3, 0x00008080);
    changes(5, 0x00000598);
    newstep(0xE4000000, 92);  // PC = 0598h
    changes(3, 0x0000807C);
    newstep(0xFF900000, 93);  // PC = 059Ch
    changes(1, 0xFFFFFFFF);
    changes(3, 0x00008078);
    newstep(0xFDB0009E, 94);  // PC = 05A0h
    changes(0, 0xFFFFFFFF);
    changes(2, 0x000080F8);
    changes(5, 0x00000278);
    newstep(0x0417F91F, 95);  // PC = 0278h
    changes(0, 0x0000001F);
    changes(1, 0x00000000);
    changes(3, 0x00008070);
    newstep(0xFD000000, 96);  // PC = 027Ch
    changes(0, 0xFFFFFFE0);
    newstep(0x6A76AF40, 97);  // PC = 0280h
    changes(0, 0xFFFFFFFE);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 98);  // PC = 0284h
    newstep(0x20940000, 99);  // PC = 0288h
    newstep(0x18625000, 100);  // PC = 028Ch
    changes(0, 0xFFFFFFE1);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 101);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 102);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 103);  // PC = 0284h
    newstep(0x20940000, 104);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 105);  // PC = 028Ch
    changes(0, 0xFFFFFFE2);
    changes(1, 0xFFFFFFFD);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 106);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 107);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 108);  // PC = 0284h
    newstep(0x20940000, 109);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 110);  // PC = 028Ch
    changes(0, 0xFFFFFFE3);
    changes(1, 0xFFFFFFF9);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 111);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 112);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 113);  // PC = 0284h
    newstep(0x20940000, 114);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 115);  // PC = 028Ch
    changes(0, 0xFFFFFFE4);
    changes(1, 0xFFFFFFF1);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 116);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 117);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 118);  // PC = 0284h
    newstep(0x20940000, 119);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 120);  // PC = 028Ch
    changes(0, 0xFFFFFFE5);
    changes(1, 0xFFFFFFE1);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 121);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 122);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 123);  // PC = 0284h
    newstep(0x20940000, 124);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 125);  // PC = 028Ch
    changes(0, 0xFFFFFFE6);
    changes(1, 0xFFFFFFC1);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 126);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 127);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 128);  // PC = 0284h
    newstep(0x20940000, 129);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 130);  // PC = 028Ch
    changes(0, 0xFFFFFFE7);
    changes(1, 0xFFFFFF81);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 131);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 132);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 133);  // PC = 0284h
    newstep(0x20940000, 134);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 135);  // PC = 028Ch
    changes(0, 0xFFFFFFE8);
    changes(1, 0xFFFFFF01);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 136);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 137);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 138);  // PC = 0284h
    newstep(0x20940000, 139);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 140);  // PC = 028Ch
    changes(0, 0xFFFFFFE9);
    changes(1, 0xFFFFFE01);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 141);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 142);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 143);  // PC = 0284h
    newstep(0x20940000, 144);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 145);  // PC = 028Ch
    changes(0, 0xFFFFFFEA);
    changes(1, 0xFFFFFC01);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 146);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 147);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 148);  // PC = 0284h
    newstep(0x20940000, 149);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 150);  // PC = 028Ch
    changes(0, 0xFFFFFFEB);
    changes(1, 0xFFFFF801);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 151);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 152);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 153);  // PC = 0284h
    newstep(0x20940000, 154);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 155);  // PC = 028Ch
    changes(0, 0xFFFFFFEC);
    changes(1, 0xFFFFF001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 156);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 157);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 158);  // PC = 0284h
    newstep(0x20940000, 159);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 160);  // PC = 028Ch
    changes(0, 0xFFFFFFED);
    changes(1, 0xFFFFE001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 161);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 162);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 163);  // PC = 0284h
    newstep(0x20940000, 164);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 165);  // PC = 028Ch
    changes(0, 0xFFFFFFEE);
    changes(1, 0xFFFFC001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 166);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 167);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 168);  // PC = 0284h
    newstep(0x20940000, 169);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 170);  // PC = 028Ch
    changes(0, 0xFFFFFFEF);
    changes(1, 0xFFFF8001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 171);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 172);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 173);  // PC = 0284h
    newstep(0x20940000, 174);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 175);  // PC = 028Ch
    changes(0, 0xFFFFFFF0);
    changes(1, 0xFFFF0001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 176);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 177);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 178);  // PC = 0284h
    newstep(0x20940000, 179);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 180);  // PC = 028Ch
    changes(0, 0xFFFFFFF1);
    changes(1, 0xFFFE0001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 181);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 182);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 183);  // PC = 0284h
    newstep(0x20940000, 184);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 185);  // PC = 028Ch
    changes(0, 0xFFFFFFF2);
    changes(1, 0xFFFC0001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 186);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 187);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 188);  // PC = 0284h
    newstep(0x20940000, 189);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 190);  // PC = 028Ch
    changes(0, 0xFFFFFFF3);
    changes(1, 0xFFF80001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 191);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 192);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 193);  // PC = 0284h
    newstep(0x20940000, 194);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0x18625000, 195);  // PC = 028Ch
    changes(0, 0xFFFFFFF4);
    changes(1, 0xFFF00001);
    changes(2, 0x000080F8);
    changes(3, 0x00008070);
    newstep(0xC13000A0, 196);  // PC = 0290h
    changes(5, 0x00000280);
    newstep(0x6A76AF40, 197);  // PC = 0280h
    changes(0, 0xFFFFFFFD);
    changes(1, 0xFFFFFFFF);
    changes(2, 0x000080F0);
    changes(3, 0x00008078);
    newstep(0x22218368, 198);  // PC = 0284h
    newstep(0x20940000, 199);  // PC = 0288h
    changes(0, 0xFFFFFFFE);
    newstep(0, -1);  // make sure last group has all changes listed.

    printf("\n%d tests, %d errors\n", tests-1, errors);
return 0;
}
